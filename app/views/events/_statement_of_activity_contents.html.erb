<%# locals: (statement_of_activity:) %>

<h1 class="border-b-0">Statement of Activity</h1>

<div class="flex gap-4 items-center">
  <%= form_with(
        method: :get,
        data: { controller: "form" },
        class: "mb-0 flex-grow flex items-center gap-4"
      ) do |form| %>
    <div class="flex gap-2 items-center w-fit text-nowrap">
      <%= form.label(:start, "From") %>
      <%= form.date_field :start, value: statement_of_activity.start_date, data: { action: "change->form#submit" }, class: "mb-0" %>
      <%= form.label(:end, "To") %>
      <%= form.date_field :end, value: statement_of_activity.end_date, data: { action: "change->form#submit" }, class: "mb-0" %>
    </div>

    <div>
      <% if statement_of_activity.supports_descendants? %>
        <%= form.check_box(
              :include_descendants,
              checked: statement_of_activity.include_descendants,
              include_hidden: false,
              data: { action: "change->form#submit" },
              class: "mb-0"
            ) %>
        <%= form.label(:include_descendants, "Include descendants", class: "inline") %>
      <% end %>
    </div>
  <% end %>

  <%= link_to(
        {
          format: :xlsx,
          **params.permit(:include_descendants, :start, :end)
        },
        class: "btn btn-small"
      ) do %>
    <%= inline_icon "download" %>
    <small>Download XLSX</small>
  <% end %>
</div>

<hr class="my-4">

<p>
  From <%= statement_of_activity.start_date.strftime("%B %-d, %Y") %>
  to <%= statement_of_activity.end_date.strftime("%B %-d, %Y") %>,
  <% if statement_of_activity.event_group %>
    the <strong><%= statement_of_activity.event_group.name %></strong> event group
  <% else %>
    <strong><%= link_to statement_of_activity.event.name, statement_of_activity.event %></strong>
    <% if statement_of_activity.include_descendants %>
      and its descendants
    <% end %>
  <% end %>
  had a change in net assets
  of <%= render_money statement_of_activity.net_asset_change %>;
  after having raised <%= render_money statement_of_activity.total_revenue %> and
  spent <%= render_money statement_of_activity.total_expense.abs %>.
</p>

<% if statement_of_activity.event_group || statement_of_activity.include_descendants %>
  <details>
    <summary>Included events</summary>
    <% if statement_of_activity.event_group && statement_of_activity.events.empty? %>
      <p>This group does not have any associated events</p>
    <% else %>
      <ul>
        <% statement_of_activity.events.each do |event| %>
          <li>
            <%= link_to(event.name, event_path(event)) %>
          </li>
        <% end %>
      </ul>
    <% end %>
  </details>
<% end %>

<table>
  <thead>
  <tr>
    <th>Category</th>
    <th>Total Amount</th>
  </tr>
  </thead>
  <tbody>
  <% if statement_of_activity.category_totals.empty? %>
    <tr>
      <td colspan="2" class="text-center p-14">
        There were no transactions in this date range.
      </td>
    </tr>
  <% else %>
    <% statement_of_activity.category_totals.each do |category_slug, amount_cents_sum| %>
      <% category = TransactionCategory::Definition::ALL[category_slug] %>
      <tr>
        <td title="<%= category&.slug %>"><%= category&.label || "Uncategorized" %></td>
        <td><%= render_money amount_cents_sum %></td>
      </tr>
    <% end %>
  <% end %>
  </tbody>
</table>
