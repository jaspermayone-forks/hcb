<% title "Home" %>
<% page_md %>

<%= render "users/nav", selected: :home if signed_in? %>

<h1 class="heading border-b-0 mb-0 pb-0 flex-col sm:flex-row items-center sm:items-start justify-center sm:justify-between center sm:text-left w-auto m-0 mt-3 gap-2">
  <div>
    <% if current_user.hack_clubber? || current_user.is_teenager? %>
      <a
        class="text-base caps muted block no-underline"
        href="https://github.com/hackclub/hcb-expansions/tree/main#hcb-what-does-it-stand-for"
        target="_blank">
        <%= @hcb_expansion %>
      </a>
    <% end %>
    <span class="<%= "warning" if fall? %>">
      Welcome to <span class="primary">HCB</span>
    </span>
  </div>
  <span class="badge ml-0 text-sm rounded-xl caps <%= Rails.env.development? ? "bg-success" : by_season("bg-muted", fall: "bg-warning") %>" id="flavor-text" data-turbo-permanent><%= flavor_text %></span>
</h1>

<% if @applications.any? %>
  <div class="my-2 ml-0 py-2 flex flex-row items-end justify-between">
    <h2 class="heading h2 line-height-4 m-0 p-0 border-none">Applications</h2>
    <%= link_to applications_path, class: "flex items-center shrink-0 no-underline" do %>
      View all applications
      <%= inline_icon "view-forward" %>
    <% end %>
  </div>

  <div class="grid grid--wide mb-12 pb-2">
    <% @applications.each do |application| %>
      <%= render partial: "event/applications/application_card", locals: { application: } %>
    <% end %>
  </div>
<% end %>

<% if current_user.card_grants.activated.size > 0 %>
  <h2 class="user-home-section">Your grants</h2>

  <div class="mixed-grid grid--spacious">
    <% current_user.card_grants.includes(:stripe_card).activated.each do |grant| %>
      <%= render "stripe_cards/stripe_card", stripe_card: grant.stripe_card, headless: true, show_purpose: true, href: card_grant_path(grant) %>
    <% end %>
    <% if current_user.card_grants.activated.size.odd? %>
      <div></div>
    <% end %>
  </div>
<% end %>

<% if current_user.card_grants.not_activated.size > 0 %>
  <h2 class="user-home-section mb-2">Pending grant invitations</h2>
  <ul class="grid grid-cols-1 text-left w-full mt-2">
    <% current_user.card_grants.not_activated.each do |grant| %>
      <div class="card mx-auto text-center sm:text-left flex items-center flex-col sm:flex-row w-full">
        <div class="flex-1">
          <p class="my-0 text-lg font-[700]">You have a grant invitation from <%= grant.event.name %></p>
          <p class="my-0 text-md"><%= render_money grant.amount %><% if grant.purpose.present? %> for <strong><%= grant.purpose %></strong><% end %></p>
        </div>
        <div class="flex flex-col items-center gap-1">
          <%= link_to "Activate my grant", grant, class: "btn" %>
          <p class="my-0 text-sm italic text-muted">
            <% if grant.expires_on.future? %>
              Spend within <%= distance_of_time_in_words(Time.current, grant.expires_on) %>
            <% else %>
              Expired <%= time_ago_in_words(grant.expires_on) %> ago
            <% end %>
          </p>
        </div>
      </div>
    <% end %>
  </ul>
<% end %>

<main class="flex flex-col items-center text-center pb-8">
  <% if signed_in? %>
    <h2 class="user-home-section mb-2 flex items-center w-full">
      <span>Your organizations</span>
      <% if @show_event_reorder_tip && @events.any? %>
        <% if @events.size > 1 %>
          <%= link_to "https://blog.hcb.hackclub.com/posts/re-order-your-homepage-247413", class: "muted flex items-center justify-end h6 ml-auto", target: "_blank" do %>
            <%= inline_icon "hand-pointer-solid", size: 18, class: "mr1" %> Drag to reorder
          <% end %>
        <% end %>
      <% end %>
    </h2>

    <% if @events.any? %>
      <ul
        class="grid grid--medium-narrow text-left w-100 mt0"
        data-controller="sortable event-sort"
        data-sortable-append-to-value="body"
        data-event-sort-organizer-positions-value="<%= @organizer_positions.pluck(:id).to_json %>"
        data-action="sortable:stop->event-sort#sort">

        <%= render partial: "events/event_card", collection: @events.not_hidden, as: :event %>

        <%= link_to Flipper.enabled?(:applications_2026_02_04) ? apply_path : apply_form_url(utm_campaign: "hcb-new-event", utm_content: "returning-organizer") do %>
          <li class="card card--hover bold font-brand flex items-center justify-center align-center h-full" style="max-width: calc(100vw - 2rem)">
            <div class="center">
              <div class="pop success mx-auto flex mb-1">
                <%= inline_icon "plus", size: 28 %>
              </div>
              New organization
            </div>
          </li>
        <% end %>
      </ul>
    <% end %>

    <% if @events.hidden.any? %>
      <details class="w-full text-left">
        <summary><h4 class="inline-block pb-0 border-none muted">Hidden organizations</h4></summary>
        <ul class="grid grid--medium-narrow text-left mt-0">
          <%= render partial: "events/event_card", collection: @events.hidden, as: :event %>
        </ul>
      </details>
    <% end %>

    <% if @events.empty? %>
      <div class="center mt0 mb0 pt4 pb4 slate bold h3 mx-auto rounded-lg border flex flex-col w-full items-center justify-center">
        <span>
          You aren't a part of an organization yet, looking to start one?
        </span>
        <%= link_to Flipper.enabled?(:applications_2026_02_04) ? apply_path : apply_form_url(utm_campaign: "hcb-new-event", utm_content: "first-time"), class: "btn bg-success mt2" do %>
          <%= inline_icon "plus" %>
          New organization
        <% end %>
      </div>
    <% end %>

    <% if @invites.any? %>
      <h2 class="w-full text-left mt-8 pb-0 border-none h2 pl-0 ml-0">Pending organization invitations</h2>
      <ul class="grid grid--narrow text-left w-full mt-2">
        <% @invites.each do |invite| %>
          <%= link_to invite do %>
            <li class="overflow-visible card card--hover flex flex-row justify-between items-center gap-2">
              <span>
                <%= status_badge "info" %>
                <strong><%= invite.event&.name %></strong>
              </span>
            </li>
          <% end %>
        <% end %>
      </ul>
    <% end %>

    <% if @invite_requests.any? %>
      <h2 class="w-full text-left mt-8 pb-0 border-none h2 pl-0 ml-0">Pending join requests</h2>
      <ul class="grid grid--narrow text-left w-full mt-2">
        <% @invite_requests.each do |invite_request| %>
          <li class="overflow-visible card card--hover flex flex-row justify-between items-center gap-2">
            <span class="w-full flex gap-2 items-center align-middle">
              <%= status_badge "info" %>
              <strong><%= invite_request.link.event.name %></strong>
              <div class="flex-grow"></div>
              <%= pop_icon_to "view-close-small",
                deny_request_path(invite_request),
                class: "error tooltipped tooltipped--w h-8 w-8",
                data: {
                  turbo_method: :post,
                  turbo_confirm: "Are you sure you want to cancel this join request?",
                },
                'aria-label': "Cancel",
                disabled: !policy(invite_request).deny? %>
            </span>
          </li>
        <% end %>
      </ul>
    <% end %>

    <%= render "static_pages/index/teenager_raffle" %>

    <%# Latest HCB announcement %>
    <% if @latest_hcb_announcement %>
      <div class="flex flex-row w-full justify-between items-center">
        <h2 class="heading h2 leading-[1.5] my-2 mt-4 mr-auto py-2 px-4 ml-0 pl-0 border-none">
          The latest from HCB
        </h2>
        <%= link_to event_announcement_overview_path(Event.find(EventMappingEngine::EventIds::HACK_CLUB_BANK)), class: "muted", target: :_blank do %>
          View all announcements
          <%= inline_icon "external", size: 18, class: "ml-1 align-text-top", style: "transform: scale(1.2)" %>
        <% end %>
      </div>
      <div class="mb-4 text-left w-full self-stretch">
        <%= render partial: "announcements/announcement_card", locals: { announcement: @latest_hcb_announcement } %>
      </div>
    <% end %>

    <%= render "static_pages/index/explore" %>

    <% valid_contracts = current_user.contracts.sent.select { |contract| contract.party(:signee).present? } %>
    <% if valid_contracts.any? %>
      <h2 class="w-full text-left mt-4 pb-0 border-none">Pending forms</h2>
      <p class="text-left my0 w-100 muted">Forms are sent to your HCB email, currently set to <%= mail_to current_user.email %>.</p>
      <ul class="grid grid--narrow grid-cols-1 text-left w-full mt-2">
        <% valid_contracts.each do |contract| %>
          <%= link_to contract_party_path(contract.party(:signee)), target: "_blank" do %>
            <li class="card card--item flex" style="gap: 4.5px; align-items: baseline">
              <%= status_badge "info" %>
              <strong>Fiscal sponsorship agreement for <%= contract.event_name %></strong>
              <small class="muted flex-grow" style="margin-left: 3.5px">
                sent <%= time_ago_in_words contract.created_at %> ago
              </small>
            </li>
          <% end %>
        <% end %>
      </ul>
    <% end %>
  <% end %>

  <% if auditor_signed_in? %>
    <%= turbo_frame_tag(:admin_tools, src: admin_tools_path, loading: :eager, target: "_top", class: "w-full") do %>
      <p>Loading admin tools</p>
    <% end %>
  <% end %>
</main>
