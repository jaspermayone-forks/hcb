<%= form_with model: user, html: {
      "x-data": "{ country: #{user.payout_method.instance_of?(User::PayoutMethod::Wire) ? "'#{user.payout_method.recipient_country}'" : "null"} }"
    } do |form| %>
  <% if user.full_name.blank? %>
    <div class="heading h3 pb2 bold">Firstly, we need to know your name:</div>
    <div class="field">
      <%= form.label :full_name, "Your full legal name" %>
      <%= form.text_field :full_name, required: true, placeholder: "Fiona Hacksworth" %>
      <span class="muted">This should match the name on your bank account and will be printed on any checks issued to you.</span>
    </div>
  <% end %>

  <fieldset>
    <legend class="heading h3 pb2 bold">How would you like to be reimbursed?</legend>
    <div class="field field--options mb-4" style="max-width: none;">
      <%= render "users/payout_form/option", form:, model: User::PayoutMethod::AchTransfer, title: "ACH transfer", description: "United States", icon: "payment-transfer" %>

      <%= render "users/payout_form/option", form:, model: User::PayoutMethod::Check, title: "Mailed check", description: "United States", icon: "email" %>

      <%= render "users/payout_form/option", form:, model: User::PayoutMethod::WiseTransfer, title: "Wise transfer", description: "International", icon: "wise" %>

      <%= render "users/payout_form/option", form:, model: User::PayoutMethod::Wire, title: "Wire transfer", description: "International", icon: "web" do %>
        <div class="badge badge--corner bg-info m1 mt0" style="width: fit-content;">$500 minimum</div>
      <% end %>
    </div>
  </fieldset>
  <% if user.payout_method&.errors&.any? %>
    <p class="error">
      <%= user.payout_method.errors.full_messages.to_sentence %>.
    </p>
  <% end %>
  <section data-behavior="check_payout_method_inputs" class="<%= "hidden" unless user.payout_method.instance_of?(User::PayoutMethod::Check) %>">
    <%= form.fields_for :payout_method, user.payout_method.instance_of?(User::PayoutMethod::Check) ? user.payout_method : User::PayoutMethod::Check.new do |form| %>
      <%= render "application/callout",
        type: "info",
        icon: "email",
        title: "Important information about mailed checks",
        class: "mt-2 mb-5",
        footer: :questions do %>
        Mailed checks can take between 10 and 12 business days to arrive. Checks can only be sent to addresses in the United States. Checks must be deposited within <strong>180 days</strong> of issuance.
      <% end %>

      <div class="field">
        <%= form.label :address_line1, "Street address" %>
        <%= form.text_field :address_line1, placeholder: StripeCardholder::DEFAULT_BILLING_ADDRESS[:line1] %>
      </div>

      <div class="field">
        <%= form.text_field :address_line2, placeholder: "(Building / Apartment / Room)" %>
      </div>

      <div class="grid grid--split">
        <div class="field flex-auto">
          <%= form.label :address_city, "City" %>
          <%= form.text_field :address_city, placeholder: StripeCardholder::DEFAULT_BILLING_ADDRESS[:city] %>
        </div>
        <div class="field flex-auto">
          <%= form.label :address_state, "State / Province" %>
          <%= form.select :address_state, ISO3166::Country.new("US").subdivisions.values.map { |s| [s.translations["en"], s.code] }, { prompt: "Select a state" } %>
        </div>
      </div>

      <div class="grid grid--split">
        <div class="field flex-auto">
          <%= form.label :postal_code %>
          <%= form.text_field :address_postal_code, placeholder: StripeCardholder::DEFAULT_BILLING_ADDRESS[:postal_code] %>
        </div>

        <div class="field flex-auto">
          <%= form.label :address_country, "Country" %>
          <%= form.text_field :address_country, value: "United States", disabled: true %>
        </div>
      </div>

      <div class="actions inline-block mt1">
        <%= form.submit "Save" %>
      </div>
    <% end %>
  </section>

  <section data-behavior="wire_payout_method_inputs" class="<%= "hidden" unless user.payout_method.instance_of?(User::PayoutMethod::Wire) %>">
    <%= form.fields_for :payout_method_wire, user.payout_method.instance_of?(User::PayoutMethod::Wire) ? user.payout_method : User::PayoutMethod::Wire.new do |form| %>
      <%= render "application/callout",
        type: "info",
        icon: "web",
        title: "Important information about Wire reimbursements",
        class: "mt-2 mb-5",
        footer: :questions do %>
        International wire transfers can take between 1 and 5 business days to arrive in your account. HCB does not charge fees for transfers, but your financial institution may choose to charge fees to receive wire transfers.
      <% end %>

      <%= render partial: "wires/recipient_details", locals: { form:, disabled: false, required: false } %>

      <div class="field">
        <%= form.label :recipient_name, "Name on account" %>
        <%= form.text_field :recipient_name,
            required: false,
            placeholder: user.full_name %>
        <span class="muted">If the name on the bank account differs from your legal name on HCB.</span>
      </div>

      <%= render partial: "wires/account_details", locals: { form:, disabled: false, required: false, account_number_field_name: :account_number } %>

      <%= render partial: "wires/country_specific_details", locals: { form:, disabled: false, required: false, excluded_fields: ["remittance_info", "purpose_code"] } %>

      <div class="actions inline-block mt1">
        <%= form.submit "Save" %>
      </div>
    <% end %>
  </section>

  <% if Flipper.enabled?(:wise_reimbursements_2025_08_25, user) %>
    <section data-behavior="wise_transfer_payout_method_inputs" class="<%= "hidden" unless user.payout_method.instance_of?(User::PayoutMethod::WiseTransfer) %>" x-data="{ currency: <%= user.payout_method.try(:currency) ? "'#{user.payout_method.currency}'" : "null" %>, amount: null, account_type: <%= user.payout_method.try(:account_type) ? "'#{user.payout_method.account_type}'" : "null" %>, use_same_email_for_interac: <%= user.payout_method.try(:use_same_email_for_interac) ? "'#{user.payout_method.use_same_email_for_interac}'" : "false" %>, email: null }">
      <%= form.fields_for :payout_method_wise_transfer, user.payout_method.instance_of?(User::PayoutMethod::WiseTransfer) ? user.payout_method : User::PayoutMethod::WiseTransfer.new do |form| %>
        <%= render "application/callout",
          type: "info",
          icon: "wise",
          title: "Important information about Wise reimbursements",
          class: "!border-[#9FE870] [&>div.flex]:text-[#163300] dark:[&>div.flex]:text-[#9FE870] mt-2 mb-5",
          footer: link_to("Learn more about Wise on HCB →", "https://help.hcb.hackclub.com/article/65-wise") do %>
          We've integrated Wise into HCB to offer international reimbursements to over 100 countries. HCB never charges fees on reimbursements, however Wise will charge processing fees to the organization reimbursing you. An account with Wise is not required; funds will be sent directly via a local bank transfer.
        <% end %>

        <%= render partial: "wise_transfers/recipient_details", locals: { form:, disabled: false } %>

        <div class="field">
          <%= form.label :currency, "Currency" %>
          <%= form.select :currency, WiseTransfer::AVAILABLE_CURRENCIES, { disabled: true }, { "@change" => "currency = $event.target.value;" } %>
        </div>

        <%= form.hidden_field :wise_recipient_id, value: "" %>

        <%= render partial: "wise_transfers/currency_specific_details", locals: { form:, disabled: false, model: User::PayoutMethod::WiseTransfer } %>

        <div class="actions inline-block mt1">
          <%= form.submit "Save" %>
        </div>
      <% end %>
    </section>
  <% end %>

  <section data-behavior="paypal_transfer_payout_method_inputs" class="<%= "hidden" unless user.payout_method.instance_of?(User::PayoutMethod::PaypalTransfer) %>">
    <%= render "application/callout", type: "error", title: "Due to integration issues, transfers via PayPal are currently unavailable.", footer: :questions do %>
      Please update your payout method to either an ACH transfer or a mailed check.
    <% end %>

    <%= render "application/callout",
        type: "info",
        title: "Important info about PayPal reimbursements" do %>
        <p>PayPal will charge domestic recipients 3% on the money sent to them via a HCB reimbursement.</p>
        <p>Outside of the US, PayPal will charge recipients both a $5 flat fee as well as ~10% fee. Governments may tax these transfers and recipients may have to pay an additional withdrawal fee.</p>
    <% end %>
    <%= form.fields_for :payout_method, user.payout_method.instance_of?(User::PayoutMethod::PaypalTransfer) ? user.payout_method : User::PayoutMethod::PaypalTransfer.new do |form| %>
      <div class="field">
        <%= form.label :recipient_email, "PayPal email" %>
        <%= form.email_field :recipient_email, placeholder: "fionah@gmail.com" %>
      </div>

      <div class="actions inline-block mt1">
        <%= form.submit "Save" %>
      </div>
    <% end %>
  </section>
  <% if user.payout_method.instance_of?(User::PayoutMethod::AchTransfer) %>
    <% errored = !user.payout_method.valid? %>
    <% r_no = user.payout_method.routing_number %>
    <% obfuscated_routing_number = "•" * [r_no.length - 4, 0].max + r_no[[-4, -1 * r_no.length].max..] %>
    <% a_no = user.payout_method.account_number %>
    <% obfuscated_account_number = "•" * [a_no.length - 4, 0].max + a_no[[-4, -1 * a_no.length].max..] %>
  <% else %>
    <% errored = false %>
    <% r_no = "" %>
    <% obfuscated_routing_number = "" %>
    <% a_no = "" %>
    <% obfuscated_account_number = "" %>
  <% end %>
  <section
    data-behavior="ach_transfer_payout_method_inputs"
    class="<%= "hidden" unless user.payout_method.instance_of?(User::PayoutMethod::AchTransfer) %>"
    x-data="
    {
      routingNumber: '<%= errored ? r_no : obfuscated_routing_number %>',
      accountNumber: '<%= errored ? a_no : obfuscated_account_number %>',
      editing: <%= errored %>,
      toggle() {
        if(!this.editing) {
          this.routingNumber = '';
          this.accountNumber = '';
          this.editing = true;
        } else if (this.routingNumber == '' && this.accountNumber == '') {
          this.editing = false;
          this.routingNumber = '<%= errored ? "" : obfuscated_routing_number %>';
          this.accountNumber = '<%= errored ? "" : obfuscated_account_number %>';
        }
      }
    }">
    <%= form.fields_for :payout_method, user.payout_method.instance_of?(User::PayoutMethod::AchTransfer) ? user.payout_method : User::PayoutMethod::AchTransfer.new do |form| %>
      <%= render "application/callout",
        type: "info",
        icon: "payment-transfer",
        title: "Important information about ACH transfers",
        class: "mt-2 mb-5",
        footer: :questions do %>
        ACH transfers can take between 1 and 3 business days to arrive in your bank account. They're the fastest option for receiving reimbursements in the United States but are not supported internationally.
      <% end %>

      <div
        class="field"
        data-controller="external-validation"
        data-external-validation-url-value="<%= validate_routing_number_ach_transfers_path %>">
        <%= form.label :routing_number, "Bank routing number" %>
        <%= form.text_field :routing_number,
                            placeholder: "123456789",
                            class: "fs-mask",
                            "@focus": "toggle()",
                            "@blur": "toggle()",
                            "x-model": "routingNumber",
                            data: { action: "input->external-validation#validate" },
                            value: "" %>
        <span class="muted" data-external-validation-target="hint"></span>
      </div>

      <div class="field">
        <%= form.label :account_number, "Bank account number" %>
        <%= form.text_field :account_number,
                            placeholder: "0913338883",
                            class: "fs-mask",
                            "@focus": "toggle()",
                            "@blur": "toggle()",
                            "x-model": "accountNumber",
                            value: "" %>
      </div>

      <div class="actions inline-block mt1">
        <%= form.submit "Save", ':disabled': "!editing", 'x-transition.duration.500ms': "" %>
      </div>
    <% end %>
  </section>
  <% if defined?(report) %>
    <%= form.hidden_field :report_id, value: report.id %>
  <% end %>
<% end %>
